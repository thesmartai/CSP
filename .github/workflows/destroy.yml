on:
  workflow_dispatch:
    inputs:
      action:
        description: "choose: plan/apply/destroy"
        required: true
        default: "plan"
      confirm_destroy:
        description: "Type DESTROY to confirm"
        required: false
        default: ""

jobs:
  destroy:
    name: Terraform Destroy
    runs-on: self-hosted
    environment: production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'

    env:
      TF_DIR: actions-runner/_work/CSP/CPS

    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Safety check (must confirm)
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "‚ùå Destroy not confirmed. Set confirm_destroy=DESTROY."
            exit 1
          fi

      - name: Restore local state (persistent)
        run: |
          set -euo pipefail
          mkdir -p "$STATE_DIR"
          mkdir -p "$GITHUB_WORKSPACE/$TF_DIR/terraform.tfstate.d/production"
          if [ -f "$STATE_DIR/terraform.tfstate" ]; then
            cp "$STATE_DIR/terraform.tfstate" "$GITHUB_WORKSPACE/$TF_DIR/terraform.tfstate.d/production/terraform.tfstate"
          fi

      - name: Init (never in current dir)
        run: terraform -chdir="$TF_DIR" init -input=false

      - name: Select workspace (create if missing)
        run: |
          set -euo pipefail
          terraform -chdir="$TF_DIR" workspace select production || terraform -chdir="$TF_DIR" workspace new production

      - name: Destroy (never in current dir)
        run: terraform -chdir="$TF_DIR" destroy -auto-approve -input=false

      - name: Persist local state (persistent)
        if: always()
        run: |
          set -euo pipefail
          mkdir -p "$STATE_DIR"
          if [ -f "$GITHUB_WORKSPACE/$TF_DIR/terraform.tfstate.d/production/terraform.tfstate" ]; then
            cp "$GITHUB_WORKSPACE/$TF_DIR/terraform.tfstate.d/production/terraform.tfstate" "$STATE_DIR/terraform.tfstate"
          elif [ -f "$GITHUB_WORKSPACE/$TF_DIR/terraform.tfstate" ]; then
            cp "$GITHUB_WORKSPACE/$TF_DIR/terraform.tfstate" "$STATE_DIR/terraform.tfstate"
          fi
