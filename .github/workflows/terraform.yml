name: Terraform
on:
  pull_request:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: terraform-production
  cancel-in-progress: false

permissions:
  contents: read

defaults:
  run:
    shell: bash
    working-directory: .

env:
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"


  # Persistenter lokaler State-Pfad auf dem Runner
  STATE_DIR: /home/ubuntu/ahmad_info/state/production

  # Terraform Variablen (GitHub Repo Secrets)
  TF_VAR_os_project: ${{ secrets.OS_PROJECT }}
  TF_VAR_os_username: ${{ secrets.OS_USERNAME }}
  TF_VAR_os_password: ${{ secrets.OS_PASSWORD }}




jobs:
  plan:
    name: Terraform Plan
    runs-on: self-hosted
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Install deps for kubeconfig generation (rsync + yq)
        run: |
          set -euo pipefail
          if ! command -v rsync >/dev/null 2>&1 || ! command -v yq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y rsync ca-certificates curl
            if ! command -v yq >/dev/null 2>&1; then
              sudo curl -fsSL -o /usr/local/bin/yq \
                https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
              sudo chmod +x /usr/local/bin/yq
            fi
          fi
          rsync --version
          yq --version

      - name: Debug runner/workspace
        run: |
          set -euo pipefail
          echo "HOST=$(hostname)"
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE:-}"
          pwd

      - name: Restore local state (persistent)
        run: |
          set -euo pipefail
          mkdir -p "$STATE_DIR"
          mkdir -p terraform.tfstate.d/production
          if [ -f "$STATE_DIR/terraform.tfstate" ]; then
            cp "$STATE_DIR/terraform.tfstate" terraform.tfstate.d/production/terraform.tfstate
          fi

      - name: Init
        run: terraform init

      - name: Select workspace (create if missing)
        run: |
          set -euo pipefail
          terraform workspace select production || terraform workspace new production

      - name: Fmt
        run: terraform fmt -check -recursive

      - name: Validate
        run: terraform validate

      - name: Debug state/workspace
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          terraform workspace show
          terraform workspace list
          ls -la terraform.tfstate* || true
          ls -la terraform.tfstate.d || true
          ls -la terraform.tfstate.d/production || true
          ls -la "$STATE_DIR" || true

      - name: Plan
        run: terraform plan -input=false -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

      - name: Persist local state (persistent)
        if: always()
        run: |
          set -euo pipefail
          mkdir -p "$STATE_DIR"
          if [ -f terraform.tfstate.d/production/terraform.tfstate ]; then
            cp terraform.tfstate.d/production/terraform.tfstate "$STATE_DIR/terraform.tfstate"
          elif [ -f terraform.tfstate ]; then
            cp terraform.tfstate "$STATE_DIR/terraform.tfstate"
          fi

  apply:
    name: Terraform Apply
    runs-on: self-hosted
    needs: plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Install deps for kubeconfig generation (rsync + yq)
        run: |
          set -euo pipefail
          if ! command -v rsync >/dev/null 2>&1 || ! command -v yq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y rsync ca-certificates curl
            if ! command -v yq >/dev/null 2>&1; then
              sudo curl -fsSL -o /usr/local/bin/yq \
                https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
              sudo chmod +x /usr/local/bin/yq
            fi
          fi
          rsync --version
          yq --version

      - name: Restore local state (persistent)
        run: |
          set -euo pipefail
          mkdir -p "$STATE_DIR"
          mkdir -p terraform.tfstate.d/production
          if [ -f "$STATE_DIR/terraform.tfstate" ]; then
            cp "$STATE_DIR/terraform.tfstate" terraform.tfstate.d/production/terraform.tfstate
          fi

      - name: Init
        run: terraform init

      - name: Select workspace (create if missing)
        run: |
          set -euo pipefail
          terraform workspace select production || terraform workspace new production

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .

      - name: Apply
        run: terraform apply -auto-approve -input=false tfplan

      - name: Persist local state (persistent)
        if: always()
        run: |
          set -euo pipefail
          mkdir -p "$STATE_DIR"
          if [ -f terraform.tfstate.d/production/terraform.tfstate ]; then
            cp terraform.tfstate.d/production/terraform.tfstate "$STATE_DIR/terraform.tfstate"
          elif [ -f terraform.tfstate ]; then
            cp terraform.tfstate "$STATE_DIR/terraform.tfstate"
          fi
      - name: Wait for Contour Ingress IP
        shell: bash
        run: |
          for i in $(seq 1 30); do
            LB_IP=$(kubectl get svc envoy -n projectcontour \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
          
            if [ -n "$LB_IP" ]; then
              echo "SUCCESS: Ingress IP ist: $LB_IP"
              echo "INGRESS_IP=$LB_IP" >> $GITHUB_ENV
              break
            fi
          
            echo "Warte auf IP... ($i/30)"
            sleep 10
          done
